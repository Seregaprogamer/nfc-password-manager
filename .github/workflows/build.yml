name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev
          
    - name: Install Buildozer
      run: |
        pip install buildozer cython==0.29.33
        
    - name: Create buildozer.spec if missing
      run: |
        if [ ! -f buildozer.spec ]; then
          cat > buildozer.spec << 'EOF'
[app]
title = NFC Password Manager
package.name = nfcpasswordmanager
package.domain = org.nfc
source.dir = .
source.main = main.py
source.include_exts = py,png,jpg,kv,atlas,json,txt
version = 1.0
requirements = python3,kivy==2.3.0,pycryptodome
android.permissions = NFC,INTERNET
android.features = android.hardware.nfc
android.minapi = 21
android.api = 30
android.arch = armeabi-v7a
orientation = portrait
fullscreen = 0
log_level = 2
EOF
        fi
        
    - name: Build APK
      run: |
        echo "Starting APK build..."
        buildozer android debug
        
        # Check if APK was created
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK successfully built!"
          ls -la bin/
        else
          echo "❌ APK build failed!"
          # Show last 50 lines of log if exists
          if [ -f .buildozer/android/platform/build-arm64-v8a_armeabi-v7a/build.log ]; then
            echo "Last 50 lines of build log:"
            tail -50 .buildozer/android/platform/build-arm64-v8a_armeabi-v7a/build.log
          fi
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: nfc-password-manager-apk
        path: bin/*.apk
        retention-days: 30
